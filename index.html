<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>åº§å¸­æŠ½é¸ã‚·ã‚¹ãƒ†ãƒ </title>

<style>
:root {
    --blue:#0062cc;
    --gray900:#1a1a1a;
    --gray200:#dbdbdb;
    --gray50:#f2f2f2;
    --white:#fff;
    --danger:#d43d35;
    --font:"Hiragino Kaku Gothic ProN","BIZ UDPGothic","Meiryo","Yu Gothic",sans-serif;
}
body{
    margin:0;padding:16px;
    font-family:var(--font);
    background:var(--gray50);
}
.container{
    max-width:1200px;
    margin:auto;
    background:var(--white);
    padding:24px;
}
.header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    border-bottom:4px solid var(--blue);
    padding-bottom:12px;
}
button{
    font-family:var(--font);
    font-weight:700;
    padding:10px 20px;
    border-radius:6px;
    cursor:pointer;
    border:2px solid transparent;
}
.primary{background:var(--blue);color:#fff;}
.secondary{background:#fff;color:var(--blue);border-color:var(--blue);}
.outline{background:#fff;border-color:#000;}
.danger{background:#fff;color:var(--danger);border-color:var(--danger);}

#maintenance{display:none;margin-top:20px;}
.role-group{
    border:1px solid var(--gray200);
    padding:16px;
    margin-bottom:16px;
    border-radius:8px;
}
.input-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
    gap:12px;
}
input,select{
    height:48px;
    padding:0 12px;
    font-size:1rem;
}

.controls{
    display:flex;
    justify-content:center;
    margin:24px 0;
}
.seat-area{
    position:relative;
    width:100%;
    height:65vh;
    border:2px solid #000;
    background:
      radial-gradient(var(--gray200) 1px, transparent 1px);
    background-size:24px 24px;
}
.seat{
    position:absolute;
    width:140px;
    height:80px;
    border:2px solid #000;
    display:flex;
    justify-content:center;
    align-items:center;
    cursor:move;
    background:#fff;
}
.seat-name{
    font-size:1.5rem;
    font-weight:800;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
}
.free-text{
    position:absolute;
    font-weight:800;
    cursor:move;
}
.delete-text{
    margin-left:8px;
    color:var(--danger);
    cursor:pointer;
    display:none;
}
.free-text:hover .delete-text{display:inline;}
</style>
</head>

<body>
<div class="container">

<div class="header">
<h1>åº§å¸­æŠ½é¸ã‚·ã‚¹ãƒ†ãƒ </h1>
<button class="secondary" onclick="toggleMaint()">ğŸ›  è¨­å®š</button>
</div>

<div id="maintenance">
<div class="role-group">
<strong>ãƒ‡ãƒ¼ã‚¿</strong><br><br>
<button class="outline" onclick="exportConfig()">ä¿å­˜</button>
<input type="file" id="importFile" hidden>
<button class="outline" onclick="document.getElementById('importFile').click()">èª­è¾¼</button>
</div>

<div id="roleInputs"></div>

<div class="role-group">
<strong>ãƒ©ãƒ™ãƒ«è¿½åŠ </strong><br><br>
<input id="newText" placeholder="ä¾‹ï¼šå…¥å£">
<input type="color" id="textColor" value="#000000">
<select id="textSize">
<option value="16px">å°</option>
<option value="24px" selected>ä¸­</option>
<option value="36px">å¤§</option>
</select>
<button class="primary" onclick="addFreeText()">è¿½åŠ </button>
</div>

<div class="role-group">
<button class="primary" onclick="saveAll()">ä¿å­˜</button>
<button class="secondary" onclick="print()">å°åˆ·</button>
<button class="danger" onclick="resetNames()">åå‰ã‚¯ãƒªã‚¢</button>
<button class="danger" onclick="fullReset()">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
</div>
</div>

<div class="controls">
<button class="primary" style="font-size:1.5rem;padding:20px;" onclick="confirmDraw()">åº§å¸­ã‚’æŠ½é¸</button>
</div>

<div id="seatArea" class="seat-area"></div>
</div>

<script>
const SNAP=12;
let counts=JSON.parse(localStorage.getItem('counts'))||{kanri:2,shomu:2,general:14};
let names=JSON.parse(localStorage.getItem('names'))||{};
let pos=JSON.parse(localStorage.getItem('pos'))||{};
let texts=JSON.parse(localStorage.getItem('texts'))||[];
let history=null;

function toggleMaint(){
 const m=document.getElementById('maintenance');
 m.style.display=m.style.display==='block'?'none':'block';
}

function renderMaint(){
 const c=document.getElementById('roleInputs');
 c.textContent='';
 const roles=[['kanri','ç®¡ç†è·'],['shomu','åº¶å‹™'],['general','ä¸€èˆ¬è·']];
 roles.forEach(([k,l])=>{
  const g=document.createElement('div');
  g.className='role-group';
  const title=document.createElement('strong');
  title.textContent=l;
  g.appendChild(title);

  const grid=document.createElement('div');
  grid.className='input-grid';

  for(let i=1;i<=counts[k];i++){
   const input=document.createElement('input');
   input.placeholder=l+i;
   input.value=names[`${k}-${i}`]||'';
   input.addEventListener('change',()=>names[`${k}-${i}`]=input.value);
   grid.appendChild(input);
  }
  g.appendChild(grid);
  c.appendChild(g);
 });
}

function syncSeats(){
 const area=document.getElementById('seatArea');
 area.querySelectorAll('.seat').forEach(e=>e.remove());
 const list=[];
 for(let i=1;i<=counts.kanri;i++)list.push(`kanri-${i}`);
 list.push('shomu-special');
 for(let i=1;i<counts.general+counts.shomu;i++)list.push(`general-${i}`);

 list.forEach((id,i)=>{
  const d=document.createElement('div');
  d.className='seat';
  d.id=id;
  const name=document.createElement('div');
  name.className='seat-name';
  name.id='name-'+id;
  name.textContent='---';
  d.appendChild(name);
  d.style.left=pos[id]?.left||(20+(i%5)*150)+'px';
  d.style.top=pos[id]?.top||(20+Math.floor(i/5)*90)+'px';
  makeDrag(d,p=>pos[id]=p);
  area.appendChild(d);
 });
}

function makeDrag(el,cb){
 let sx,sy,ol,ot;
 el.onmousedown=e=>{
  sx=e.clientX;sy=e.clientY;
  ol=el.offsetLeft;ot=el.offsetTop;
  document.onmousemove=m=>{
   el.style.left=ol+(m.clientX-sx)+'px';
   el.style.top=ot+(m.clientY-sy)+'px';
  };
  document.onmouseup=()=>{
   el.style.left=Math.round(el.offsetLeft/SNAP)*SNAP+'px';
   el.style.top=Math.round(el.offsetTop/SNAP)*SNAP+'px';
   cb({left:el.style.left,top:el.style.top});
   document.onmousemove=null;
  };
 };
}

function confirmDraw(){
 if(confirm('æŠ½é¸ã—ã¾ã™ã‹ï¼Ÿ')){
  history={};
  document.querySelectorAll('.seat-name').forEach(e=>history[e.id]=e.textContent);
  draw();
 }
}

function draw(){
 const g=k=>Array.from({length:counts[k]},(_,i)=>names[`${k}-${i+1}`]||`${k}${i+1}`)
  .sort(()=>Math.random()-0.5);
 g('kanri').forEach((n,i)=>set(`kanri-${i+1}`,n));
 const s=g('shomu');
 set('shomu-special',s[0]||'---');
 [...s.slice(1),...g('general')].forEach((n,i)=>set(`general-${i+1}`,n));
}
function set(id,v){
 const e=document.getElementById('name-'+id);
 if(e)e.textContent=v;
}

function addFreeText(){
 const t=document.getElementById('newText').value;
 if(!t)return;
 texts.push({id:'t'+Date.now(),text:t,color:textColor.value,size:textSize.value,left:'100px',top:'100px'});
 renderTexts();
 document.getElementById('newText').value='';
}

function renderTexts(){
 document.querySelectorAll('.free-text').forEach(e=>e.remove());
 texts.forEach(t=>{
  const d=document.createElement('div');
  d.className='free-text';
  d.style.color=t.color;
  d.style.fontSize=t.size;
  d.style.left=t.left;
  d.style.top=t.top;

  const s=document.createElement('span');
  s.textContent=t.text;
  const x=document.createElement('span');
  x.textContent='Ã—';
  x.className='delete-text';
  x.onclick=()=>{texts=texts.filter(e=>e.id!==t.id);renderTexts();};

  d.appendChild(s);d.appendChild(x);
  makeDrag(d,p=>{t.left=p.left;t.top=p.top;});
  seatArea.appendChild(d);
 });
}

function saveAll(){
 localStorage.setItem('counts',JSON.stringify(counts));
 localStorage.setItem('names',JSON.stringify(names));
 localStorage.setItem('pos',JSON.stringify(pos));
 localStorage.setItem('texts',JSON.stringify(texts));
 alert('ä¿å­˜ã—ã¾ã—ãŸ');
}
function exportConfig(){
 const b=new Blob([JSON.stringify({counts,names,pos,texts})]);
 const a=document.createElement('a');
 a.href=URL.createObjectURL(b);
 a.download='seat.json';
 a.click();
}
importFile.onchange=e=>{
 const r=new FileReader();
 r.onload=()=>{const d=JSON.parse(r.result);counts=d.counts;names=d.names;pos=d.pos;texts=d.texts;saveAll();location.reload();};
 r.readAsText(e.target.files[0]);
};
function resetNames(){if(confirm('æ¶ˆå»?')){names={};renderMaint();}}
function fullReset(){if(confirm('å…¨å‰Šé™¤?')){localStorage.clear();location.reload();}}

renderMaint();syncSeats();renderTexts();
</script>
</body>
</html>
