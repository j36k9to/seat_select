<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åº§å¸­æŠ½é¸ã‚·ã‚¹ãƒ†ãƒ  - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ç‰ˆ</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-blue-600: #0062cc;
            --color-gray-900: #1a1a1a;
            --color-gray-700: #4d4d4d;
            --color-gray-200: #dbdbdb;
            --color-gray-50: #f2f2f2;
            --color-white: #ffffff;
            --color-error: #d43d35;
            --font-main: 'BIZ UDPGothic', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--color-gray-50);
            color: var(--color-gray-900);
            margin: 0;
            padding: 16px;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--color-white);
            padding: clamp(16px, 4vw, 32px);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            border-bottom: 4px solid var(--color-blue-600);
            padding-bottom: 12px;
        }

        h1 { margin: 0; font-size: 1.6rem; font-weight: 700; }

        button {
            font-family: var(--font-main);
            font-size: 1rem;
            font-weight: 700;
            padding: 10px 20px;
            border-radius: 6px;
            border: 2px solid transparent;
            cursor: pointer;
            min-height: 48px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary { background-color: var(--color-blue-600); color: var(--color-white); }
        .btn-secondary { background-color: var(--color-white); color: var(--color-blue-600); border-color: var(--color-blue-600); }
        .btn-outline { background-color: var(--color-white); color: var(--color-gray-900); border-color: var(--color-gray-900); }
        .btn-danger { background-color: var(--color-white); color: var(--color-error); border-color: var(--color-error); }

        #maintenanceArea {
            display: none;
            background: #fafafa;
            border: 1px solid var(--color-gray-200);
            padding: 20px;
            margin-bottom: 24px;
        }

        .role-group {
            background: var(--color-white);
            padding: 16px;
            border: 1px solid var(--color-gray-200);
            margin-bottom: 16px;
            border-radius: 8px;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }

        input[type="text"] {
            font-family: var(--font-main);
            font-size: 1rem;
            height: 48px;
            border: 2px solid var(--color-gray-200);
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
            padding: 0 12px;
        }

        .seat-area {
            position: relative;
            width: 100%;
            height: 65vh;
            background: var(--color-white);
            border: 2.5px solid var(--color-gray-900);
            overflow: hidden;
            background-image: radial-gradient(var(--color-gray-200) 1px, transparent 1px);
            background-size: 24px 24px;
            touch-action: none;
        }

        .seat {
            position: absolute;
            width: 140px;
            height: 80px;
            border: 2.5px solid var(--color-gray-900);
            background: var(--color-white);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: move;
            user-select: none;
            z-index: 10;
            border-radius: 4px;
        }

        .seat-name { 
            font-size: 1.5rem; 
            font-weight: 700; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 90%;
            text-align: center;
        }

        .free-text { 
            position: absolute; 
            cursor: move; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            z-index: 5;
            padding: 4px;
        }

        .delete-text { 
            color: var(--color-error); 
            margin-left: 8px; 
            cursor: pointer; 
            display: none;
            border: 2px solid var(--color-error);
            border-radius: 50%;
            width: 20px; height: 20px;
            justify-content: center; align-items: center;
            background: white;
        }

        .free-text:hover .delete-text { display: flex; }

        .admin-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            border-top: 1px solid var(--color-gray-200);
            padding-top: 24px;
        }

        @media print {
            .header-bar, #maintenanceArea, .controls-main, .delete-text { display: none !important; }
            .seat-area { border: none !important; height: auto !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-bar">
        <h1>åº§å¸­æŠ½é¸ã‚·ã‚¹ãƒ†ãƒ </h1>
        <button class="btn-secondary" id="maintToggle" onclick="toggleMaintenance()">ğŸ›  è¨­å®šã‚’é–‹ã</button>
    </div>

    <div id="maintenanceArea">
        <div class="role-group">
            <p style="font-weight:700;">ãƒ‡ãƒ¼ã‚¿ã®å…¥å‡ºåŠ›</p>
            <div style="display: flex; gap: 12px;">
                <button class="btn-outline" onclick="exportConfig()">ä¿å­˜ç”¨ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›</button>
                <input type="file" id="importFile" style="display:none" onchange="importConfig(this)">
                <button class="btn-outline" onclick="document.getElementById('importFile').click()">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€</button>
            </div>
        </div>

        <div id="roleInputs"></div>

        <div class="role-group">
            <p style="font-weight:700;">ãƒ©ãƒ™ãƒ«è¿½åŠ </p>
            <div style="display: flex; gap: 12px; align-items: center;">
                <input type="text" id="newText" placeholder="ä¾‹: å…¥å£" style="width:200px;">
                <button class="btn-primary" onclick="addFreeText()">è¿½åŠ </button>
            </div>
        </div>

        <div class="admin-actions">
            <button class="btn-primary" onclick="saveAll()">ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜</button>
            <button class="btn-secondary" onclick="window.print()">å°åˆ·ãƒ»PDF</button>
            <button class="btn-danger" onclick="resetNames()">åå‰ã‚¯ãƒªã‚¢</button>
            <button class="btn-danger" onclick="fullReset()">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>

    <div class="controls-main">
        <button class="btn-primary" style="width: 300px; font-size: 1.4rem;" onclick="confirmAndDraw()">åº§å¸­ã‚’æŠ½é¸ã™ã‚‹</button>
        <button id="undoBtn" class="btn-outline" style="display:none; margin-left:10px;" onclick="undoResult()">â¤¶ æˆ»ã™</button>
    </div>

    <div id="seatArea" class="seat-area"></div>
</div>

<script>
    const STORAGE_KEY = 'seat_system_v11_secure';
    let counts = { shomu: 2, general: 14 };
    let names = {};
    let pos = {};
    let texts = [];
    let lastShomuIndex = 1; 
    let history = null;

    // --- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–: ã‚µãƒ‹ã‚¿ã‚¤ã‚ºé–¢æ•° ---
    function escapeHTML(str) {
        if (!str) return '';
        return str.replace(/[&<>"']/g, function(m) {
            return {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m];
        });
    }

    function init() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const d = JSON.parse(saved);
            counts = d.counts || counts;
            names = d.names || {};
            pos = d.pos || {};
            texts = d.texts || [];
            lastShomuIndex = d.lastShomuIndex ?? 1;
        }
        renderMaint(); syncSeats(); renderTexts();
    }

    function toggleMaintenance() {
        const area = document.getElementById('maintenanceArea');
        area.style.display = (area.style.display === 'block') ? 'none' : 'block';
    }

    function renderMaint() {
        const container = document.getElementById('roleInputs');
        container.innerHTML = '';
        const roles = [{k:'shomu', l:'åº¶å‹™æ‹…å½“'}, {k:'general', l:'ä¸€èˆ¬è·å“¡'}];
        roles.forEach(role => {
            let items = '';
            for(let i=1; i<=counts[role.k]; i++) {
                const val = escapeHTML(names[`${role.k}-${i}`] || '');
                items += `<div class="input-item"><input type="text" placeholder="${role.l}${i}" value="${val}" onchange="updateName('${role.k}-${i}', this.value)"></div>`;
            }
            container.innerHTML += `<div class="role-group"><strong>${role.l}</strong><div class="input-grid">${items}</div></div>`;
        });
    }

    function updateName(id, val) {
        names[id] = escapeHTML(val);
    }

    function syncSeats() {
        const area = document.getElementById('seatArea');
        area.querySelectorAll('.seat').forEach(s => s.remove());
        const list = [{id:'shomu-special', label:'åº¶å‹™å¸­'}];
        for(let i=1; i<=(counts.general + counts.shomu - 1); i++) list.push({id:`general-${i}`, label:''});

        list.forEach((d, i) => {
            const el = document.createElement('div');
            el.className = 'seat'; el.id = `box-${d.id}`;
            el.innerHTML = `<div style="font-size:0.7rem; color:#666">${d.label}</div><div class="seat-name" id="name-${d.id}">---</div>`;
            el.style.left = pos[d.id]?.left || (20 + (i%5)*150)+"px";
            el.style.top = pos[d.id]?.top || (20 + Math.floor(i/5)*90)+"px";
            makeDraggable(el, (p) => pos[d.id] = p);
            area.appendChild(el);
        });
    }

    function makeDraggable(el, onStop) {
        let startX, startY, initialL, initialT;
        const onStart = (e) => {
            if(e.target.classList.contains('delete-text')) return;
            const c = e.type.includes('touch') ? e.touches[0] : e;
            startX = c.clientX; startY = c.clientY;
            initialL = el.offsetLeft; initialT = el.offsetTop;
            document.onmousemove = document.ontouchmove = (ev) => {
                const moveC = ev.type.includes('touch') ? ev.touches[0] : ev;
                el.style.left = (initialL + moveC.clientX - startX) + "px";
                el.style.top = (initialT + moveC.clientY - startY) + "px";
            };
            document.onmouseup = document.ontouchend = () => {
                document.onmousemove = document.ontouchmove = null;
                onStop({left: el.style.left, top: el.style.top});
            };
        };
        el.onmousedown = el.ontouchstart = onStart;
    }

    function confirmAndDraw() {
        if(confirm('æŠ½é¸ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')){
            history = {}; 
            document.querySelectorAll('.seat-name').forEach(e => history[e.id] = e.innerText);
            draw();
            document.getElementById('undoBtn').style.display = 'inline-flex';
        }
    }

    function draw() {
        const shomuNames = [names['shomu-1'] || 'åº¶å‹™1', names['shomu-2'] || 'åº¶å‹™2'];
        const currentIdx = (lastShomuIndex === 0) ? 1 : 0;
        const specName = shomuNames[currentIdx];
        const subShomu = shomuNames[currentIdx === 0 ? 1 : 0];
        
        lastShomuIndex = currentIdx;
        const generalNames = Array.from({length:counts.general}, (_,i) => names[`general-${i+1}`] || `è·å“¡${i+1}`);
        const combined = [subShomu, ...generalNames].sort(()=>Math.random()-0.5);

        document.getElementById('name-shomu-special').innerText = specName;
        combined.forEach((n,i) => {
            const e = document.getElementById(`name-general-${i+1}`);
            if(e) e.innerText = n;
        });
    }

    function undoResult() {
        if(!history) return;
        for(let id in history) document.getElementById(id).innerText = history[id];
        lastShomuIndex = (lastShomuIndex === 0) ? 1 : 0;
        document.getElementById('undoBtn').style.display = 'none';
    }

    function addFreeText() {
        const val = escapeHTML(document.getElementById('newText').value);
        if(!val) return;
        const t = { id:'t'+Date.now(), text:val, left:'100px', top:'100px' };
        texts.push(t); renderTexts();
        document.getElementById('newText').value = '';
    }

    function renderTexts() {
        document.querySelectorAll('.free-text').forEach(e => e.remove());
        texts.forEach(t => {
            const el = document.createElement('div'); el.className = 'free-text';
            el.style.left = t.left; el.style.top = t.top;
            el.innerHTML = `<span>${t.text}</span><span class="delete-text" onclick="deleteText('${t.id}')">Ã—</span>`;
            makeDraggable(el, (p) => { t.left=p.left; t.top=p.top; });
            document.getElementById('seatArea').appendChild(el);
        });
    }

    function deleteText(id) { texts = texts.filter(x => x.id !== id); renderTexts(); }

    function saveAll() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({counts, names, pos, texts, lastShomuIndex}));
        alert('ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã—ã¾ã—ãŸã€‚');
    }

    function exportConfig() {
        const blob = new Blob([JSON.stringify({counts,names,pos,texts,lastShomuIndex})],{type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `seat_config.json`; a.click();
    }

    function importConfig(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const d = JSON.parse(e.target.result);
                // ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã«ã™ã¹ã¦ã®åå‰ã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚º
                for(let k in d.names) d.names[k] = escapeHTML(d.names[k]);
                names = d.names; counts = d.counts; pos = d.pos; texts = d.texts; lastShomuIndex = d.lastShomuIndex;
                saveAll(); location.reload();
            } catch(err) { alert('èª­ã¿è¾¼ã¿å¤±æ•—'); }
        };
        reader.readAsText(input.files[0]);
    }

    function resetNames() { if(confirm('åå‰ã‚’ã‚¯ãƒªã‚¢ï¼Ÿ')){ names={}; renderMaint(); saveAll(); } }
    function fullReset() { if(confirm('å…¨ã¦ãƒªã‚»ãƒƒãƒˆï¼Ÿ')){ localStorage.clear(); location.reload(); } }

    init();
</script>

</body>
</html>
