<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åº§å¸­æŠ½é¸ã‚·ã‚¹ãƒ†ãƒ  - å®Œå…¨çµ±åˆç‰ˆ</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-blue-600: #0062cc;
            --color-gray-900: #1a1a1a;
            --color-gray-200: #dbdbdb;
            --color-gray-50: #f2f2f2;
            --color-white: #ffffff;
            --font-main: 'BIZ UDPGothic', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--color-gray-50);
            margin: 0; padding: clamp(10px, 3vw, 20px);
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--color-white);
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--color-blue-600);
            padding-bottom: 10px;
        }

        /* è¨­å®šã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #maintenanceArea {
            display: none;
            background: #fdfdfd;
            padding: 20px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
            border-radius: 6px;
        }

        .role-group {
            background: white;
            padding: 15px;
            border: 1px solid #eee;
            margin-bottom: 15px;
            border-radius: 6px;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: var(--font-main);
        }

        /* åº§å¸­ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .seat-area-wrapper {
            width: 100%;
            position: relative;
            padding-top: 56.25%; /* 16:9 */
            background: #fff;
            border: 2px solid var(--color-gray-900);
            border-radius: 4px;
            overflow: hidden;
            touch-action: none;
        }

        .seat-area {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: radial-gradient(var(--color-gray-200) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .seat {
            position: absolute;
            width: 12.5%; height: 12.5%;
            border: 2px solid var(--color-gray-900);
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: move;
            z-index: 10;
            border-radius: 4px;
            box-sizing: border-box;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.05);
        }

        .seat-label { font-size: 0.6rem; color: #666; margin-bottom: 2px; }
        .seat-name { font-size: 1.2vw; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 90%; text-align: center; }

        @media (max-width: 600px) { .seat-name { font-size: 3vw; } }

        .controls-main { display: flex; justify-content: center; gap: 10px; margin: 25px 0; }
        
        button {
            font-family: var(--font-main); font-weight: 700; cursor: pointer;
            border-radius: 6px; border: 1px solid #ccc; padding: 8px 16px;
        }

        .btn-draw {
            padding: 15px 40px; font-size: 1.3rem; background: var(--color-blue-600); color: white; border: none;
            box-shadow: 0 4px 0 #004a99;
        }
        .btn-draw:active { transform: translateY(2px); box-shadow: 0 2px 0 #004a99; }

        @media print {
            #maintenanceArea, .controls-main, #maintToggleBtn { display: none !important; }
            .container { box-shadow: none; max-width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-bar">
        <h1 style="font-size: 1.3rem; margin:0;">åº§å¸­æŠ½é¸ã‚·ã‚¹ãƒ†ãƒ </h1>
        <button id="maintToggleBtn" onclick="toggleMaintenance()">ğŸ›  è¨­å®šã‚’é–‹ã</button>
    </div>

    <div id="maintenanceArea">
        <div id="roleInputs"></div>

        <div class="role-group">
            <p style="margin-top:0; font-weight:700;">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</p>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button onclick="exportConfig()">JSONå‡ºåŠ›ï¼ˆé…å¸ƒç”¨ï¼‰</button>
                <input type="file" id="importFile" style="display:none" onchange="importConfig(this)">
                <button onclick="document.getElementById('importFile').click()">JSONèª­è¾¼</button>
                <button onclick="saveAll()" style="background:#0062cc; color:white; border:none;">ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜</button>
                <button onclick="resetNames()" style="color:red;">åå‰ã‚’ã‚¯ãƒªã‚¢</button>
            </div>
        </div>
    </div>

    <div class="controls-main">
        <button class="btn-draw" onclick="confirmAndDraw()">åº§å¸­ã‚’æŠ½é¸ã™ã‚‹</button>
        <button id="undoBtn" style="display:none;" onclick="undoResult()">â¤¶ æˆ»ã™</button>
    </div>

    <div class="seat-area-wrapper">
        <div id="seatArea" class="seat-area"></div>
    </div>
</div>

<script>
    const STORAGE_KEY = 'seat_system_v14_final_all';
    let names = {};
    let pos = {};
    let lastShomuIndex = 1; 
    let history = null;
    const counts = { shomu: 2, general: 14 };

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ï¼šã‚µãƒ‹ã‚¿ã‚¤ã‚º
    function escapeHTML(str) {
        if (!str) return '';
        return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function init() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const d = JSON.parse(saved);
            pos = d.pos || {};
            names = d.names || {};
            lastShomuIndex = d.lastShomuIndex ?? 1;
        }
        renderMaint();
        syncSeats();
    }

    function toggleMaintenance() {
        const area = document.getElementById('maintenanceArea');
        const btn = document.getElementById('maintToggleBtn');
        const isHidden = area.style.display === 'none' || area.style.display === '';
        area.style.display = isHidden ? 'block' : 'none';
        btn.innerText = isHidden ? 'âœ– è¨­å®šã‚’é–‰ã˜ã‚‹' : 'ğŸ›  è¨­å®šã‚’é–‹ã';
    }

    function renderMaint() {
        const container = document.getElementById('roleInputs');
        container.innerHTML = '';
        const roles = [{k:'shomu', l:'åº¶å‹™æ‹…å½“'}, {k:'general', l:'ä¸€èˆ¬è·å“¡'}];
        
        roles.forEach(role => {
            let items = '';
            const n = role.k === 'shomu' ? counts.shomu : counts.general;
            for(let i=1; i<=n; i++) {
                const id = `${role.k}-${i}`;
                const val = escapeHTML(names[id] || '');
                items += `<div class="input-item"><input type="text" placeholder="${role.l}${i}" value="${val}" onchange="updateName('${id}', this.value)"></div>`;
            }
            container.innerHTML += `<div class="role-group"><strong>${role.l} (${n}å)</strong><div class="input-grid">${items}</div></div>`;
        });
    }

    function updateName(id, val) { names[id] = escapeHTML(val); }

    function syncSeats() {
        const area = document.getElementById('seatArea');
        area.innerHTML = '';
        const list = [{id:'shomu-special', label:'åº¶å‹™å¸­'}];
        for(let i=1; i<=15; i++) list.push({id:`general-${i}`, label:''});

        list.forEach((d, i) => {
            const el = document.createElement('div');
            el.className = 'seat'; el.id = `box-${d.id}`;
            el.innerHTML = `<div class="seat-label">${d.label}</div><div class="seat-name" id="name-${d.id}">---</div>`;
            el.style.left = pos[d.id]?.left || (5 + (i % 5) * 18) + "%";
            el.style.top = pos[d.id]?.top || (5 + Math.floor(i / 5) * 20) + "%";
            makeDraggable(el, d.id);
            area.appendChild(el);
        });
    }

    function makeDraggable(el, id) {
        let isDragging = false;
        const area = document.getElementById('seatArea');
        const start = () => { isDragging = true; };
        const move = (e) => {
            if (!isDragging) return;
            const rect = area.getBoundingClientRect();
            const c = e.type.includes('touch') ? e.touches[0] : e;
            let xP = ((c.clientX - rect.left) / rect.width) * 100;
            let yP = ((c.clientY - rect.top) / rect.height) * 100;
            xP = Math.max(0, Math.min(xP - 6, 87.5)); 
            yP = Math.max(0, Math.min(yP - 6, 87.5));
            el.style.left = xP + "%"; el.style.top = yP + "%";
            pos[id] = { left: el.style.left, top: el.style.top };
        };
        const end = () => { isDragging = false; };
        el.onmousedown = el.ontouchstart = start;
        document.addEventListener('mousemove', move);
        document.addEventListener('touchmove', move, {passive: false});
        document.addEventListener('mouseup', end);
        document.addEventListener('touchend', end);
    }

    function confirmAndDraw() {
        if(!confirm('åº§å¸­ã‚’æŠ½é¸ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
        history = {};
        document.querySelectorAll('.seat-name').forEach(e => history[e.id] = e.innerText);
        draw();
        document.getElementById('undoBtn').style.display = 'inline-flex';
    }

    function draw() {
        const shomuNames = [names['shomu-1'] || 'åº¶å‹™1', names['shomu-2'] || 'åº¶å‹™2'];
        const currentIdx = (lastShomuIndex === 0) ? 1 : 0;
        const specName = shomuNames[currentIdx];
        const subShomu = shomuNames[currentIdx === 0 ? 1 : 0];
        lastShomuIndex = currentIdx;

        const generalNames = Array.from({length:counts.general}, (_,i) => names[`general-${i+1}`] || `è·å“¡${i+1}`);
        const combined = [subShomu, ...generalNames].sort(()=>Math.random()-0.5);

        document.getElementById('name-shomu-special').innerText = specName;
        combined.forEach((n,i) => {
            const e = document.getElementById(`name-general-${i+1}`);
            if(e) e.innerText = n;
        });
    }

    function undoResult() {
        if(!history) return;
        for(let id in history) document.getElementById(id).innerText = history[id];
        lastShomuIndex = (lastShomuIndex === 0) ? 1 : 0;
        document.getElementById('undoBtn').style.display = 'none';
    }

    function saveAll() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({pos, names, lastShomuIndex}));
        alert("ä¿å­˜ã—ã¾ã—ãŸã€‚");
    }

    function exportConfig() {
        const data = JSON.stringify({pos, names, lastShomuIndex});
        const blob = new Blob([data], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "seat_layout_final.json";
        a.click();
    }

    function importConfig(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const d = JSON.parse(e.target.result);
                pos = d.pos; names = d.names; lastShomuIndex = d.lastShomuIndex;
                saveAll(); location.reload();
            } catch(err) { alert('èª­ã¿è¾¼ã¿å¤±æ•—'); }
        };
        reader.readAsText(input.files[0]);
    }

    function resetNames() { if(confirm('åå‰ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) { names = {}; renderMaint(); saveAll(); } }
    function fullReset() { if(confirm('å…¨ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.clear(); location.reload(); } }

    init();
</script>
</body>
</html>
