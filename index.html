<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åº§å¸­æŠ½é¸ã‚·ã‚¹ãƒ†ãƒ  - é«˜è¦–èªæ€§Webãƒ•ã‚©ãƒ³ãƒˆç‰ˆ</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-blue-600: #0062cc;
            --color-gray-900: #1a1a1a;
            --color-gray-700: #4d4d4d;
            --color-gray-200: #dbdbdb;
            --color-gray-50: #f2f2f2;
            --color-white: #ffffff;
            --color-error: #d43d35;
            /* Webãƒ•ã‚©ãƒ³ãƒˆã‚’æœ€å„ªå…ˆã«æŒ‡å®š */
            --font-main: 'BIZ UDPGothic', "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Meiryo", "Yu Gothic", sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--color-gray-50);
            color: var(--color-gray-900);
            margin: 0;
            padding: 16px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--color-white);
            padding: clamp(16px, 4vw, 32px);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            border-bottom: 4px solid var(--color-blue-600);
            padding-bottom: 12px;
        }

        h1 { margin: 0; font-size: 1.6rem; font-weight: 700; letter-spacing: 0.05em; }

        button {
            font-family: var(--font-main);
            font-size: 1rem;
            font-weight: 700;
            padding: 10px 20px;
            border-radius: 6px;
            border: 2px solid transparent;
            cursor: pointer;
            min-height: 48px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary { background-color: var(--color-blue-600); color: var(--color-white); }
        .btn-secondary { background-color: var(--color-white); color: var(--color-blue-600); border-color: var(--color-blue-600); }
        .btn-outline { background-color: var(--color-white); color: var(--color-gray-900); border-color: var(--color-gray-900); }
        .btn-danger { background-color: var(--color-white); color: var(--color-error); border-color: var(--color-error); }

        #maintenanceArea {
            display: none;
            background: #fafafa;
            border: 1px solid var(--color-gray-200);
            padding: 20px;
            margin-bottom: 24px;
        }

        .role-group {
            background: var(--color-white);
            padding: 16px;
            border: 1px solid var(--color-gray-200);
            margin-bottom: 16px;
            border-radius: 8px;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }

        input[type="text"], select {
            font-family: var(--font-main);
            font-size: 1rem;
            height: 48px;
            border: 2px solid var(--color-gray-200);
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
            padding: 0 12px;
        }

        input[type="color"] {
            -webkit-appearance: none;
            border: 2px solid var(--color-gray-200);
            border-radius: 6px;
            height: 48px;
            width: 60px;
            padding: 4px;
            background: var(--color-white);
            cursor: pointer;
            box-sizing: border-box;
        }

        .controls-main {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin: 24px 0;
        }

        .seat-area {
            position: relative;
            width: 100%;
            height: 65vh;
            background: var(--color-white);
            border: 2.5px solid var(--color-gray-900);
            overflow: hidden;
            background-image: radial-gradient(var(--color-gray-200) 1px, transparent 1px);
            background-size: 24px 24px;
            touch-action: none;
        }

        .seat {
            position: absolute;
            width: 140px;
            height: 80px;
            border: 2.5px solid var(--color-gray-900);
            background: var(--color-white);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: move;
            user-select: none;
            box-sizing: border-box;
            z-index: 10;
            text-align: center;
            border-radius: 4px;
        }

        .seat-name { 
            font-size: 1.5rem; 
            font-weight: 700; 
            letter-spacing: -0.02em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 4px;
        }

        .free-text { 
            position: absolute; 
            cursor: move; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            white-space: nowrap; 
            z-index: 5;
            padding: 4px;
        }

        .delete-text { 
            color: var(--color-error); 
            margin-left: 8px; 
            font-size: 1rem; 
            cursor: pointer; 
            background: white; 
            border-radius: 50%; 
            width: 22px; 
            height: 22px; 
            display: none;
            align-items: center; 
            justify-content: center; 
            border: 2px solid var(--color-error);
        }

        .free-text:hover .delete-text { display: flex; }

        .admin-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            border-top: 1px solid var(--color-gray-200);
            padding-top: 24px;
            margin-top: 24px;
        }

        @media print {
            .header-bar, #maintenanceArea, .controls-main, .delete-text { display: none !important; }
            .seat-area { border: none !important; height: auto !important; overflow: visible !important; }
            .seat { border: 2.5px solid #000 !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-bar">
        <h1>åº§å¸­æŠ½é¸ã‚·ã‚¹ãƒ†ãƒ </h1>
        <button class="btn-secondary" id="maintToggle" onclick="toggleMaintenance()">ğŸ›  è¨­å®šã‚’é–‹ã</button>
    </div>

    <div id="maintenanceArea">
        <div class="role-group">
            <p style="margin-top:0; font-weight:700;">ãƒ‡ãƒ¼ã‚¿ã®å…¥å‡ºåŠ›</p>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn-outline" onclick="exportConfig()">PCã«ä¿å­˜ï¼ˆé…å¸ƒç”¨ï¼‰</button>
                <input type="file" id="importFile" style="display:none" onchange="importConfig(this)">
                <button class="btn-outline" onclick="document.getElementById('importFile').click()">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€</button>
            </div>
        </div>

        <div id="roleInputs"></div>

        <div class="role-group">
            <p style="margin-top:0; font-weight:700;">ãƒ©ãƒ™ãƒ«ã®è¿½åŠ </p>
            <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                <input type="text" id="newText" placeholder="ä¾‹: å…¥å£" style="width:180px;">
                <input type="color" id="textColor" value="#1a1a1a" title="æ–‡å­—è‰²ã‚’é¸æŠ">
                <select id="textSize" style="width:100px;">
                    <option value="16px">å°</option>
                    <option value="24px" selected>ä¸­</option>
                    <option value="36px">å¤§</option>
                </select>
                <button class="btn-primary" onclick="addFreeText()">è¿½åŠ </button>
            </div>
        </div>

        <div class="admin-actions">
            <button class="btn-primary" style="padding: 12px 32px;" onclick="saveAll()">ãƒ–ãƒ©ã‚¦ã‚¶ã«ç¾åœ¨ã®æ§‹æˆã‚’ä¿å­˜</button>
            <button class="btn-secondary" onclick="window.print()">å°åˆ·ãƒ»PDFå‡ºåŠ›</button>
            <button class="btn-danger" onclick="resetNames()">ç™»éŒ²åã‚’ã‚¯ãƒªã‚¢</button>
            <button class="btn-danger" onclick="fullReset()">å…¨è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>

    <div class="controls-main">
        <div style="width: 100px; visibility: hidden;"></div>
        <button class="btn-primary" style="flex-grow: 1; max-width: 400px; font-size: 1.5rem; padding: 20px; border-radius: 12px;" onclick="confirmAndDraw()">åº§å¸­ã‚’æŠ½é¸ã™ã‚‹</button>
        <div style="width: 100px; text-align: left;">
            <button id="undoBtn" class="btn-outline" style="display:none; font-size: 0.9rem; min-height: 40px;" onclick="undoResult()">â¤¶ æˆ»ã™</button>
        </div>
    </div>

    <div id="seatArea" class="seat-area"></div>
</div>

<script>
    const SNAP = 12;
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚­ãƒ¼ã‚’v8ã«æ›´æ–°ã—ã¦æ•´åˆæ€§ã‚’ç¢ºä¿
    const STORAGE_KEY_PREFIX = 'seat_system_v8_';
    
    let counts = JSON.parse(localStorage.getItem(STORAGE_KEY_PREFIX + 'counts')) || { kanri: 2, shomu: 2, general: 14 };
    let names = JSON.parse(localStorage.getItem(STORAGE_KEY_PREFIX + 'names')) || {};
    let pos = JSON.parse(localStorage.getItem(STORAGE_KEY_PREFIX + 'pos')) || {};
    let texts = JSON.parse(localStorage.getItem(STORAGE_KEY_PREFIX + 'texts')) || [];
    let history = null;

    function init() { renderMaint(); syncSeats(); renderTexts(); }

    function toggleMaintenance() {
        const area = document.getElementById('maintenanceArea');
        const btn = document.getElementById('maintToggle');
        const isOpen = area.style.display === 'block';
        area.style.display = isOpen ? 'none' : 'block';
        btn.innerText = isOpen ? 'ğŸ›  è¨­å®šã‚’é–‹ã' : 'âœ– è¨­å®šã‚’é–‰ã˜ã‚‹';
    }

    function renderMaint() {
        const container = document.getElementById('roleInputs');
        container.innerHTML = '';
        const roles = [{k:'kanri', l:'ç®¡ç†è·'}, {k:'shomu', l:'åº¶å‹™'}, {k:'general', l:'ä¸€èˆ¬è·'}];
        roles.forEach(role => {
            let items = '';
            for(let i=1; i<=counts[role.k]; i++) {
                const val = names[`${role.k}-${i}`] || '';
                items += `<div class="input-item"><input type="text" placeholder="${role.l}${i}" value="${val}" onchange="names['${role.k}-${i}']=this.value"></div>`;
            }
            container.innerHTML += `
                <div class="role-group">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <strong>${role.l}</strong>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-outline" style="min-height:36px; padding:0 15px;" onclick="updateCount('${role.k}',-1)">ãƒ¼</button>
                            <button class="btn-outline" style="min-height:36px; padding:0 15px;" onclick="updateCount('${role.k}',1)">ï¼‹</button>
                        </div>
                    </div>
                    <div class="input-grid">${items}</div>
                </div>`;
        });
    }

    function updateCount(k, d) {
        if(counts[k]+d < 0) return;
        counts[k] += d; renderMaint(); syncSeats();
    }

    function syncSeats() {
        const area = document.getElementById('seatArea');
        area.querySelectorAll('.seat').forEach(s => s.remove());
        const list = [];
        for(let i=1; i<=counts.kanri; i++) list.push({id:`kanri-${i}`});
        list.push({id:`shomu-special`});
        for(let i=1; i<=(counts.general + counts.shomu - 1); i++) list.push({id:`general-${i}`});

        list.forEach((d, i) => {
            const el = document.createElement('div');
            el.className = 'seat'; el.id = `box-${d.id}`;
            el.innerHTML = `<div class="seat-name" id="name-${d.id}">---</div>`;
            el.style.left = pos[d.id]?.left || (24 + (i%5)*150)+"px";
            el.style.top = pos[d.id]?.top || (24 + Math.floor(i/5)*90)+"px";
            makeDraggable(el, (p) => pos[d.id] = p);
            area.appendChild(el);
        });
    }

    function makeDraggable(el, onStop) {
        let startX, startY, initialL, initialT;
        const onStart = (e) => {
            if(e.target.className === 'delete-text') return;
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            startX = clientX; startY = clientY;
            initialL = el.offsetLeft; initialT = el.offsetTop;
            document.addEventListener(e.type.includes('touch') ? 'touchmove' : 'mousemove', onMove, { passive: false });
            document.addEventListener(e.type.includes('touch') ? 'touchend' : 'mouseup', onEnd);
        };
        const onMove = (e) => {
            e.preventDefault();
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            el.style.left = (initialL + (clientX - startX)) + "px";
            el.style.top = (initialT + (clientY - startY)) + "px";
        };
        const onEnd = () => {
            const L = Math.round(el.offsetLeft/SNAP)*SNAP+"px";
            const T = Math.round(el.offsetTop/SNAP)*SNAP+"px";
            el.style.left = L; el.style.top = T;
            onStop({left: L, top: T});
            document.removeEventListener('touchmove', onMove);
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('touchend', onEnd);
            document.removeEventListener('mouseup', onEnd);
        };
        el.addEventListener('mousedown', onStart);
        el.addEventListener('touchstart', onStart, { passive: false });
    }

    function confirmAndDraw() {
        if(confirm('åº§å¸­ã®æŠ½é¸ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')){
            const cur = {}; document.querySelectorAll('.seat-name').forEach(e => cur[e.id]=e.innerText);
            history = cur;
            draw();
            document.getElementById('undoBtn').style.display = 'inline-flex';
        }
    }

    function draw() {
        const get = (k) => Array.from({length:counts[k]}, (_,i) => names[`${k}-${i+1}`] || `${k}${i+1}`);
        const ks = get('kanri').sort(()=>Math.random()-0.5);
        const ss = get('shomu').sort(()=>Math.random()-0.5);
        const gs = [...ss.slice(1), ...get('general')].sort(()=>Math.random()-0.5);
        ks.forEach((n,i) => { const e=document.getElementById(`name-kanri-${i+1}`); if(e) e.innerText=n; });
        const specEl = document.getElementById('name-shomu-special');
        if(specEl) specEl.innerText = ss[0] || '---';
        gs.forEach((n,i) => { const e=document.getElementById(`name-general-${i+1}`); if(e) e.innerText=n; });
    }

    function undoResult() {
        if(!history) return;
        for(let id in history) { const e=document.getElementById(id); if(e) e.innerText=history[id]; }
        document.getElementById('undoBtn').style.display='none'; history=null;
    }

    function addFreeText() {
        const val = document.getElementById('newText').value; if(!val) return;
        const color = document.getElementById('textColor').value;
        const size = document.getElementById('textSize').value;
        const t = { id:'t'+Date.now(), text:val, color:color, size:size, left:'100px', top:'100px' };
        texts.push(t); renderTexts(); document.getElementById('newText').value = '';
    }

    function renderTexts() {
        document.querySelectorAll('.free-text').forEach(e => e.remove());
        texts.forEach(t => {
            const el = document.createElement('div'); el.className = 'free-text'; el.id = t.id;
            el.style.cssText = `color:${t.color}; font-size:${t.size}; left:${t.left}; top:${t.top};`;
            el.innerHTML = `<span>${t.text}</span><span class="delete-text" onclick="deleteText('${t.id}')">Ã—</span>`;
            makeDraggable(el, (p) => { const target = texts.find(x => x.id === t.id); if(target) { target.left=p.left; target.top=p.top; } });
            document.getElementById('seatArea').appendChild(el);
        });
    }

    function deleteText(id) { texts = texts.filter(x => x.id !== id); renderTexts(); }

    function saveAll() { 
        localStorage.setItem(STORAGE_KEY_PREFIX + 'counts', JSON.stringify(counts)); 
        localStorage.setItem(STORAGE_KEY_PREFIX + 'names', JSON.stringify(names)); 
        localStorage.setItem(STORAGE_KEY_PREFIX + 'pos', JSON.stringify(pos)); 
        localStorage.setItem(STORAGE_KEY_PREFIX + 'texts', JSON.stringify(texts)); 
        alert('ç¾åœ¨ã®è¨­å®šã¨è·å“¡åã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚'); 
    }

    function exportConfig() { 
        const blob = new Blob([JSON.stringify({counts,names,pos,texts})],{type:'application/json'}); 
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); 
        a.download = `åº§å¸­è¨­å®š.json`; a.click(); 
    }

    function importConfig(input) { 
        const reader = new FileReader(); 
        reader.onload = (e) => { 
            try { 
                const d = JSON.parse(e.target.result); 
                counts=d.counts; names=d.names; pos=d.pos; texts=d.texts; 
                saveAll(); location.reload(); 
            } catch(err) { alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); } 
        }; 
        reader.readAsText(input.files[0]); 
    }

    function resetNames() { if(confirm('ç™»éŒ²ã•ã‚ŒãŸè·å“¡åã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')){ names={}; renderMaint(); syncSeats(); saveAll(); } }
    function fullReset() { if(confirm('ã™ã¹ã¦ã®è¨­å®šã€é…ç½®ã€è·å“¡åã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ')){ localStorage.clear(); location.reload(); } }

    init();
</script>

</body>
</html>
