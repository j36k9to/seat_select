<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>座席抽選システム - ユニバーサル・レイアウト版</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-blue-600: #0062cc;
            --color-gray-900: #1a1a1a;
            --color-gray-200: #dbdbdb;
            --color-gray-50: #f2f2f2;
            --color-white: #ffffff;
            --font-main: 'BIZ UDPGothic', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--color-gray-50);
            margin: 0; padding: 10px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--color-white);
            padding: 20px;
        }

        /* 座席エリアの縦横比を固定 (16:9) */
        .seat-area-wrapper {
            width: 100%;
            position: relative;
            padding-top: 56.25%; /* 16:9 の比率 */
            background: #fff;
            border: 2px solid var(--color-gray-900);
            overflow: hidden;
        }

        .seat-area {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: radial-gradient(var(--color-gray-200) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* 座席サイズも%で指定することで伸縮に対応 */
        .seat {
            position: absolute;
            width: 12%;  /* 全体の幅に対して */
            height: 12%; /* 全体の高さに対して */
            border: 2px solid var(--color-gray-900);
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: move;
            z-index: 10;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .seat-name {
            font-size: 1.2vw; /* 画面幅に応じて文字サイズも変化 */
            font-weight: 700;
        }

        @media (max-width: 600px) {
            .seat-name { font-size: 3vw; } /* スマホでは少し大きく */
        }

        .controls-main { text-align: center; margin: 20px 0; }
        #maintenanceArea { display: none; background: #f9f9f9; padding: 15px; border: 1px solid #ddd; margin-bottom: 20px; }
        
        /* 印刷設定 */
        @media print {
            #maintenanceArea, .controls-main { display: none !important; }
            body { padding: 0; }
            .container { max-width: 100%; box-shadow: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1 style="font-size: 1.2rem;">座席抽選システム (固定比率版)</h1>
        <button onclick="toggleMaintenance()" style="padding:5px 10px;">設定</button>
    </div>

    <div id="maintenanceArea">
        <button onclick="exportConfig()">JSON出力（このレイアウトを配布）</button>
        <input type="file" id="importFile" style="display:none" onchange="importConfig(this)">
        <button onclick="document.getElementById('importFile').click()">JSON読込</button>
        <button onclick="saveAll()" style="background:#0062cc; color:white;">ブラウザ保存</button>
    </div>

    <div class="controls-main">
        <button onclick="draw()" style="padding:15px 30px; font-size:1.2rem; cursor:pointer;">抽選実行</button>
    </div>

    <div class="seat-area-wrapper">
        <div id="seatArea" class="seat-area"></div>
    </div>
</div>

<script>
    const STORAGE_KEY = 'seat_system_v12_proportional';
    let names = {};
    let pos = {}; // ここに % で座標を保存する
    let counts = { shomu: 2, general: 14 };

    function init() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const d = JSON.parse(saved);
            pos = d.pos || {};
            names = d.names || {};
        }
        syncSeats();
    }

    function syncSeats() {
        const area = document.getElementById('seatArea');
        area.innerHTML = '';
        
        const list = [{id:'shomu-special', label:'庶務'}];
        for(let i=1; i<=15; i++) list.push({id:`general-${i}`, label:''});

        list.forEach((d, i) => {
            const el = document.createElement('div');
            el.className = 'seat';
            el.id = `box-${d.id}`;
            el.innerHTML = `<div style="font-size:0.6rem;">${d.label}</div><div class="seat-name" id="name-${d.id}">---</div>`;
            
            // 保存された % 座標を適用。なければ初期値を計算
            const left = pos[d.id]?.left || (5 + (i % 6) * 15) + "%";
            const top = pos[d.id]?.top || (5 + Math.floor(i / 6) * 20) + "%";
            
            el.style.left = left;
            el.style.top = top;
            
            makeDraggable(el, d.id);
            area.appendChild(el);
        });
    }

    function makeDraggable(el, id) {
        let isDragging = false;
        const area = document.getElementById('seatArea');

        const start = (e) => { isDragging = true; };
        const move = (e) => {
            if (!isDragging) return;
            const rect = area.getBoundingClientRect();
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            
            // マウス位置を親要素に対する % に変換
            let xP = ((clientX - rect.left) / rect.width) * 100;
            let yP = ((clientY - rect.top) / rect.height) * 100;

            // 枠外に出ないよう制限
            xP = Math.max(0, Math.min(xP - 6, 88)); 
            yP = Math.max(0, Math.min(yP - 6, 88));

            el.style.left = xP + "%";
            el.style.top = yP + "%";
            pos[id] = { left: xP + "%", top: yP + "%" };
        };
        const end = () => { isDragging = false; };

        el.onmousedown = el.ontouchstart = start;
        document.onmousemove = document.ontouchmove = move;
        document.onmouseup = document.ontouchend = end;
    }

    function draw() {
        // (省略していた抽選ロジックをここに実装)
        const combined = Array.from({length:16}, (_,i) => `職員${i+1}`).sort(()=>Math.random()-0.5);
        document.querySelectorAll('.seat-name').forEach((el, i) => {
            el.innerText = combined[i];
        });
    }

    function toggleMaintenance() {
        const m = document.getElementById('maintenanceArea');
        m.style.display = m.style.display === 'block' ? 'none' : 'block';
    }

    function saveAll() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({pos, names}));
        alert("レイアウトを保存しました");
    }

    function exportConfig() {
        const data = JSON.stringify({pos, names});
        const blob = new Blob([data], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "seat_layout_proportional.json";
        a.click();
    }

    function importConfig(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const d = JSON.parse(e.target.result);
            pos = d.pos; names = d.names;
            saveAll(); location.reload();
        };
        reader.readAsText(input.files[0]);
    }

    init();
</script>
</body>
</html>
